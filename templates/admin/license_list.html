{% extends 'admin/master.html' %}
{% block body %}
<div class="container-fluid">
    <div class="row">
        <div class="col-lg-10 col-md-12 col-sm-12">
            <div class="panel panel-default">
                <div class="panel-heading">
                    <h3 class="panel-title">Licenses</h3>
                </div>
                <div class="panel-body">
                    <h4>Send Data to All Licenses</h4>
                    <form id="send-data-form" class="form-inline" onsubmit="return false;">
                        <div class="form-group" style="margin-bottom:15px;">
                            <label class="control-label" style="margin-right:8px;">Stocks & Actions:</label>
                            <div>
                                {% set stocks = ['XAUSD', 'US30', 'USOIL', 'BTCUSD'] %}
                                <div class="row" style="margin-left:0;">
                                    {% for stock in stocks %}
                                    <div class="col-xs-12" style="margin-bottom:18px;">
                                        <div class="panel panel-info" style="margin-bottom:0;">
                                            <div class="panel-heading" style="padding:5px 10px;">
                                                <strong>{{ stock }}</strong>
                                            </div>
                                            <div class="panel-body" style="padding:8px;">
                                                <div class="form-inline" style="margin-bottom:0; display: flex; align-items: center;">
                                                    <div class="btn-group" role="group" aria-label="{{ stock }}" style="margin-right:16px;">
                                                        <button type="button" class="btn btn-primary" style="margin-right:8px; min-width:90px;" onclick="sendPreset('buy', '{{ stock }}')">Buy</button>
                                                        <button type="button" class="btn btn-danger" style="margin-right:8px; min-width:90px;" onclick="sendPreset('closelong', '{{ stock }}')">BuyExit</button>
                                                    </div>
                                                    <label for="risk-{{ stock }}" class="control-label" style="margin-right:8px; margin-bottom:0;">Risk:</label>
                                                    <input type="number" step="any" id="risk-{{ stock }}" class="form-control" placeholder="Risk value" required style="width:120px; margin-right:20px;">
                                                    <div class="btn-group" role="group" aria-label="{{ stock }}">
                                                        <button type="button" class="btn btn-success" style="margin-right:8px; min-width:90px;" onclick="sendPreset('sell', '{{ stock }}')">Sell</button>
                                                        <button type="button" class="btn btn-warning" style="margin-right:8px; min-width:90px;" onclick="sendPreset('closesell', '{{ stock }}')">SellExit</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </form>
                    <div id="send-status" class="alert alert-info" style="margin-top:15px; display:none;"></div>
                    <hr>
                    <a href="{{ url_for('.add') }}" class="btn btn-success" style="margin-bottom: 15px;">
                        <span class="fa fa-plus"></span> Add License
                    </a>
                    <table class="table table-bordered table-striped" id="license-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>License Key</th>
                                <th>Status</th>
                                <th>Delete</th>
                            </tr>
                        </thead>
                        <tbody>
                        {% for lic in licenses %}
                            <tr id="license-row-{{ loop.index0 }}">
                                <td>{{ lic.name }}</td>
                                <td class="license-key-cell" id="license-key-{{ loop.index0 }}">{{ lic.license_key }}</td>
                                <td id="license-status-{{ loop.index0 }}"></td>
                                <td>
                                    <form method="post" action="{{ url_for('.delete', idx=loop.index0) }}" style="display:inline;">
                                        <button type="submit" class="btn btn-danger btn-xs">
                                            <span class="fa fa-trash"></span> Delete
                                        </button>
                                    </form>
                                </td>
                            </tr>
                        {% else %}
                            <tr>
                                <td colspan="4" class="text-center text-muted">No licenses found.</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
function sendPreset(action, stock) {
    var riskInput = document.getElementById('risk-' + stock);
    var risk = riskInput ? riskInput.value.trim() : '';
    if (!risk) {
        alert("Please enter a risk value for " + stock + ".");
        if (riskInput) riskInput.focus();
        return false;
    }
    var payload = "{license}," + action + "," + stock + ",risk=" + risk;
    sendDataToLicenses(payload, stock, action);
    return false;
}

function sendDataToLicenses(presetData, stock, action) {
    var statusDiv = document.getElementById('send-status');
    statusDiv.style.display = "block";
    statusDiv.innerHTML = "Sending...";
    var dataToSend = presetData;
    fetch("{{ url_for('.send') }}", {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({data: dataToSend})
    })
    .then(response => response.json())
    .then(result => {
        statusDiv.innerHTML = result.status || "All requests sent.";
        // Display per-license status
        if (result.success && result.success.length > 0) {
            result.success.forEach(function(item) {
                var idx = findLicenseIndex(item.license);
                if (idx !== -1) {
                    document.getElementById('license-status-' + idx).innerHTML =
                        "<span class='text-success'>OK</span><br><small class='text-muted'>" + (item.response || "") + "</small>";
                }
            });
        }
        if (result.errors && result.errors.length > 0) {
            result.errors.forEach(function(item) {
                var idx = findLicenseIndex(item.license);
                if (idx !== -1) {
                    document.getElementById('license-status-' + idx).innerHTML =
                        "<span class='text-danger'>" + item.status + "</span><br><small class='text-muted'>" + (item.response || "") + "</small>";
                }
            });
        }
    })
    .catch(() => {
        statusDiv.innerHTML = "Request failed.";
    });
    return false; // Prevent form submit
}

// Helper to find license index by license key in the table
function findLicenseIndex(licenseKey) {
    var cells = document.querySelectorAll('.license-key-cell');
    for (var i = 0; i < cells.length; i++) {
        if (cells[i].textContent === licenseKey) {
            return i;
        }
    }
    return -1;
}
</script>
{% endblock %}
